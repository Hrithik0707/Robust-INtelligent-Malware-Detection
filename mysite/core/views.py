from django.shortcuts import render, redirect
from django.core.files.storage import FileSystemStorage
from django.urls import reverse_lazy
import pefile
import os
import sys
import pandas as pd
from .forms import BookForm
from .models import Book
from .extraxtor import *
from joblib import load



def upload(request):
    context = {}
    if request.method == 'POST':
        uploaded_file = request.FILES['document']
        fs = FileSystemStorage()
        name = fs.save(uploaded_file.name, uploaded_file)
        filepath = os.path.abspath(name)
        l = filepath.split('/')
        s = '/'.join(l[:len(l)-1])
        s+='/media'
        s+='/'+l[-1]
        pe = s
        pe = pefile.PE(pe)
        features = extract_features(pe)
        df_test = pd.DataFrame([features])
        path = os.path.abspath("model.joblib")
        print(path)     
        clf = load(path)
        result = clf.predict(df_test)
        if result[0]==0:
            scan_result= "Benign file."
        else:
            scan_result = "Malicious file."
        print(scan_result)
        
    return render(request, 'newui.html', context)


def scan_file(filepath):
    scan_result=""
    pe = pefile.PE(filepath)
    features = extract_features(pe)
    df_test = pd.DataFrame([features])
    clf = load("random_forest_53_raw_features.joblib")
    result = clf.predict(df_test)
    if result[0]==0:
        scan_result= "Benign file."
    else:
        scan_result = "Malicious file."
    return scan_result


